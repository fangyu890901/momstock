<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StockTrack Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .up { color: #ef4444; }
        .down { color: #22c55e; }
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0) !important; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="h-14 bg-white border-b flex items-center justify-between px-4 z-40 shrink-0">
        <button onclick="toggleSidebar()" class="p-2 text-gray-600 text-xl">â˜°</button>
        <h1 id="view-title" class="text-md font-bold text-gray-800 tracking-tight">é¦–é ç¸½è¦½</h1>
        <button onclick="handleHeaderAdd()" class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center font-bold shadow-lg">+</button>
    </header>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white z-50 border-r shadow-2xl -translate-x-full">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <span class="font-bold italic text-gray-800">StockTrack</span>
            <button onclick="toggleSidebar()" class="text-gray-400">âœ•</button>
        </div>
        <div class="p-4 space-y-2">
            <button onclick="showHome(); toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 bg-gray-100 rounded-xl text-gray-800 font-bold mb-4">
                <span>ğŸ </span> <span>è¿”å›é¦–é ç¸½è¦½</span>
            </button>
            
            <input type="text" id="sidebar-search" oninput="renderSidebar()" placeholder="æœå°‹è‚¡ç¥¨..." 
                class="w-full bg-gray-50 border border-gray-100 rounded-xl py-2 px-3 text-sm outline-none">
            
            <div class="pt-2 text-[10px] font-black text-gray-400 uppercase tracking-widest px-1">æŒè‚¡æ¸…å–®</div>
            <nav id="stock-list-menu" class="space-y-1 overflow-y-auto max-h-[60vh] no-scrollbar"></nav>
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-45 hidden"></div>

    <main class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
        <div id="main-content"></div>
        <div class="h-20"></div>
    </main>

    <footer class="h-16 bg-white border-t flex items-center justify-around z-40 shrink-0 pb-safe">
        <button onclick="showHome()" class="flex flex-col items-center gap-1 text-gray-600">
            <span class="text-xl">ğŸ </span><span class="text-[10px] font-bold">é¦–é </span>
        </button>
        <button onclick="exportData()" class="flex flex-col items-center gap-1 text-blue-600">
            <span class="text-xl">ğŸ“¥</span><span class="text-[10px] font-bold">å‚™ä»½</span>
        </button>
        <button onclick="importData()" class="flex flex-col items-center gap-1 text-orange-600">
            <span class="text-xl">ğŸ“¤</span><span class="text-[10px] font-bold">é‚„åŸ</span>
        </button>
        <input type="file" id="importFile" class="hidden" onchange="processFile(this)">
    </footer>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-[100]">
        <div class="bg-white rounded-t-3xl p-6 w-full max-w-md shadow-2xl">
            <h3 id="modal-title" class="text-lg font-bold mb-6 text-gray-800">æ–°å¢åƒ¹æ ¼è¨˜éŒ„</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-5">
                <input type="text" id="stockName" class="w-full bg-gray-50 rounded-xl p-4 outline-none border border-transparent focus:border-black" placeholder="è‚¡ç¥¨åç¨±">
                <div class="flex gap-3">
                    <input type="date" id="stockDate" class="flex-1 bg-gray-50 rounded-xl p-4 outline-none text-sm border border-transparent">
                    <input type="number" id="stockPrice" step="0.01" class="flex-1 bg-gray-50 rounded-xl p-4 outline-none border border-transparent" placeholder="æ”¶ç›¤åƒ¹" autofocus>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="closeModal()" class="flex-1 py-4 text-gray-400 font-bold">å–æ¶ˆ</button>
                    <button onclick="saveData()" class="flex-1 py-4 bg-black text-white rounded-xl font-bold shadow-lg">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="note-modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-[100]">
        <div class="bg-white rounded-t-3xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4 text-gray-800">ç·¨è¼¯é™¤æ¯å‚™è¨»</h3>
            <input type="hidden" id="note-target-name">
            <textarea id="note-content" rows="6" class="w-full bg-gray-50 rounded-2xl p-4 outline-none text-sm resize-none mb-6" placeholder="è¼¸å…¥å‚™è¨»..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeNoteModal()" class="flex-1 py-4 text-gray-400 font-bold">å–æ¶ˆ</button>
                <button onclick="saveNote()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let stockData = JSON.parse(localStorage.getItem('stocks_v3')) || [];
        let stockNotes = JSON.parse(localStorage.getItem('stock_notes_v3')) || {};
        let pinnedStocks = JSON.parse(localStorage.getItem('pinned_stocks')) || [];
        let currentViewContext = { type: 'home', name: '' };

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function renderSidebar() {
            const menu = document.getElementById('stock-list-menu');
            const query = document.getElementById('sidebar-search').value.toLowerCase();
            const unique = [...new Set(stockData.map(s => s.name))].filter(n => n.toLowerCase().includes(query));
            menu.innerHTML = unique.map(name => `
                <button onclick="showStockDetail('${name}'); toggleSidebar();" class="w-full text-left px-4 py-3 rounded-xl transition text-sm flex items-center justify-between ${currentViewContext.name === name ? 'bg-black text-white' : 'text-gray-600'}">
                    <span>${name}</span><span>${pinnedStocks.includes(name) ? 'ğŸ“Œ' : ''}</span>
                </button>
            `).join('');
        }

        function showHome() {
            currentViewContext = { type: 'home', name: '' };
            document.getElementById('view-title').innerText = "é¦–é ç¸½è¦½";
            renderSidebar();
            const unique = [...new Set(stockData.map(s => s.name))];
            document.getElementById('main-content').innerHTML = `<div class="grid grid-cols-2 gap-3">
                ${unique.map(name => `
                    <div onclick="showStockDetail('${name}')" class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm relative active:scale-95 transition">
                        <h3 class="font-bold text-gray-800 text-sm truncate">${name}</h3>
                        <p class="text-[10px] text-gray-400 mt-1 line-clamp-1">${stockNotes[name] || 'æŸ¥çœ‹å ±è¡¨'}</p>
                    </div>
                `).join('')}
            </div>`;
        }

        function showStockDetail(name) {
            currentViewContext = { type: 'detail', name };
            document.getElementById('view-title').innerText = name;
            renderSidebar();
            const filtered = stockData.filter(s => s.name === name).sort((a, b) => new Date(a.date) - new Date(b.date));
            const displayData = filtered.map((entry, index) => {
                const prev = index > 0 ? filtered[index - 1] : null;
                const diff = prev ? (entry.price - prev.price).toFixed(2) : 0;
                const percent = prev ? ((diff / prev.price) * 100).toFixed(2) : 0; // è¨ˆç®—ç™¾åˆ†æ¯”
                return { ...entry, diff: parseFloat(diff), percent: parseFloat(percent) };
            }).reverse();

            document.getElementById('main-content').innerHTML = `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-2"><p class="text-blue-500 text-[10px] font-black">é™¤æ¯å‚™è¨»</p><button onclick="togglePin('${name}')">${pinnedStocks.includes(name) ? 'ğŸ“Œ' : 'ğŸ“'}</button></div>
                    <p class="text-gray-700 text-sm mb-4">${(stockNotes[name] || 'å°šæœªç´€éŒ„...').replace(/\n/g, '<br>')}</p>
                    <button onclick="openNoteModal('${name}')" class="w-full py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold">âœ å¿«é€Ÿç·¨è¼¯å‚™è¨»</button>
                </div>
                <div class="bg-white rounded-3xl shadow-sm overflow-hidden">
                    ${displayData.map(s => `
                        <div class="flex items-center justify-between p-4 border-b border-gray-50 active:bg-gray-50" onclick="editEntry(${s.id})">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 font-bold">${s.date}</span>
                                <span class="text-md font-black text-gray-800">$ ${s.price}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <div class="text-sm font-black ${s.diff >= 0 ? 'up' : 'down'}">${s.diff > 0 ? '+' : ''}${s.diff}</div>
                                    <div class="text-[10px] font-bold ${s.diff >= 0 ? 'up' : 'down'}">${s.diff > 0 ? '+' : ''}${s.percent}%</div> </div>
                                <button onclick="event.stopPropagation(); deleteEntry(${s.id}, '${name}')" class="text-gray-200 p-2">âœ•</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function handleHeaderAdd() { openModal(currentViewContext.name || ''); }

        function openModal(preName = '') {
            document.getElementById('stockName').value = preName;
            document.getElementById('stockName').disabled = !!preName;
            // é—œéµå„ªåŒ–ï¼šè‡ªå‹•å¸¶å…¥ç•¶å¤©æ—¥æœŸ
            document.getElementById('stockDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal').classList.replace('hidden', 'flex');
        }

        function closeModal() { document.getElementById('modal').classList.replace('flex', 'hidden'); document.getElementById('edit-id').value = ''; }

        function saveData() {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('stockName').value.trim();
            const date = document.getElementById('stockDate').value;
            const price = parseFloat(document.getElementById('stockPrice').value);
            if (!name || !date || isNaN(price)) return;
            if (id) {
                const idx = stockData.findIndex(s => s.id == id);
                stockData[idx] = { ...stockData[idx], name, date, price };
            } else {
                stockData.push({ id: Date.now(), name, date, price });
            }
            localStorage.setItem('stocks_v3', JSON.stringify(stockData));
            closeModal(); showStockDetail(name);
        }

        function editEntry(id) {
            const entry = stockData.find(s => s.id == id);
            document.getElementById('edit-id').value = entry.id;
            openModal(entry.name);
            document.getElementById('stockDate').value = entry.date;
            document.getElementById('stockPrice').value = entry.price;
        }

        function deleteEntry(id, name) { if(confirm("åˆªé™¤ï¼Ÿ")) { stockData = stockData.filter(i => i.id !== id); localStorage.setItem('stocks_v3', JSON.stringify(stockData)); showStockDetail(name); } }
        function togglePin(name) { pinnedStocks = pinnedStocks.includes(name) ? pinnedStocks.filter(n => n !== name) : [...pinnedStocks, name]; localStorage.setItem('pinned_stocks', JSON.stringify(pinnedStocks)); showStockDetail(name); }
        function openNoteModal(name) { document.getElementById('note-target-name').value = name; document.getElementById('note-content').value = stockNotes[name] || ''; document.getElementById('note-modal').classList.replace('hidden', 'flex'); }
        function closeNoteModal() { document.getElementById('note-modal').classList.replace('flex', 'hidden'); }
        function saveNote() { const name = document.getElementById('note-target-name').value; stockNotes[name] = document.getElementById('note-content').value; localStorage.setItem('stock_notes_v3', JSON.stringify(stockNotes)); closeNoteModal(); showStockDetail(name); }

        // å‚™ä»½é‚„åŸé‚è¼¯
        function exportData() {
            const backup = { stocks: stockData, notes: stockNotes, pins: pinnedStocks };
            const blob = new Blob([JSON.stringify(backup)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `stock_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        function importData() { document.getElementById('importFile').click(); }
        function processFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                if(confirm("é‚„åŸå°‡è“‹éç¾æœ‰è³‡æ–™ï¼Ÿ")) {
                    localStorage.setItem('stocks_v3', JSON.stringify(data.stocks));
                    localStorage.setItem('stock_notes_v3', JSON.stringify(data.notes));
                    localStorage.setItem('pinned_stocks', JSON.stringify(data.pins));
                    location.reload();
                }
            };
            reader.readAsText(input.files[0]);
        }

        showHome();
    </script>
</body>
</html>
